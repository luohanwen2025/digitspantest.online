<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Backward Digit Span Test Game</title>
    <link rel="stylesheet" href="css/game.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .game-container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 800px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .game-title {
            text-align: center;
            color: #667eea;
            font-size: 2rem;
            margin-bottom: 30px;
            font-weight: 700;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 30px;
        }

        .progress-grid {
            display: flex;
            gap: 4px;
            height: 100%;
        }

        .progress-cell {
            flex: 1;
            background: #d1d5db;
            border-radius: 2px;
            transition: background 0.3s ease;
        }

        .progress-cell.active {
            background: #667eea;
        }

        .progress-cell.completed {
            background: #10b981;
        }

        .progress-cell.failed {
            background: #ef4444;
        }

        .game-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .level-indicator {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: 600;
            font-size: 1.1rem;
        }

        .score-indicator {
            background: rgba(102, 126, 234, 0.1);
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: 600;
            font-size: 1.1rem;
            color: #667eea;
        }

        .timer-bar {
            width: 100%;
            height: 6px;
            background: #e5e7eb;
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 30px;
            display: none;
        }

        .timer-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.1s linear;
        }

        .number-display {
            text-align: center;
            font-size: 5rem;
            font-weight: 700;
            color: #667eea;
            margin: 40px 0;
            min-height: 150px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Courier New', monospace;
            letter-spacing: 0.2em;
        }

        .number-display.fade {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }

        .input-area {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .answer-input {
            width: 100%;
            padding: 15px;
            font-size: 1.5rem;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            text-align: center;
            font-family: 'Courier New', monospace;
            transition: border-color 0.3s ease;
        }

        .answer-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .answer-input.error {
            border-color: #ef4444;
            animation: shake 0.5s ease-in-out;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        .submit-btn {
            padding: 15px 40px;
            font-size: 1.2rem;
            font-weight: 600;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .submit-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .submit-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .feedback {
            text-align: center;
            font-size: 1.2rem;
            font-weight: 600;
            min-height: 30px;
            margin-top: 15px;
        }

        .feedback.correct {
            color: #10b981;
        }

        .feedback.incorrect {
            color: #ef4444;
        }

        .feedback.instruction {
            color: #6b7280;
        }

        .start-screen {
            text-align: center;
        }

        .start-screen h2 {
            color: #667eea;
            font-size: 2rem;
            margin-bottom: 20px;
        }

        .game-rules {
            background: #f9fafb;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 30px;
            text-align: left;
        }

        .game-rules ul {
            list-style: none;
            padding: 0;
        }

        .game-rules li {
            padding: 8px 0;
            padding-left: 25px;
            position: relative;
        }

        .game-rules li:before {
            content: "‚úì";
            position: absolute;
            left: 0;
            color: #667eea;
            font-weight: bold;
        }

        .start-btn {
            padding: 15px 40px;
            font-size: 1.2rem;
            font-weight: 600;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .start-btn:hover {
            transform: translateY(-2px);
        }

        .result-screen {
            text-align: center;
        }

        .result-screen h2 {
            color: #667eea;
            font-size: 2rem;
            margin-bottom: 30px;
        }

        .score-display {
            font-size: 3rem;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 20px;
        }

        .performance {
            font-size: 1.5rem;
            color: #6b7280;
            margin-bottom: 30px;
        }

        .restart-btn {
            padding: 15px 40px;
            font-size: 1.2rem;
            font-weight: 600;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
        }

        @media (max-width: 768px) {
            .game-container {
                padding: 20px;
            }

            .game-title {
                font-size: 1.5rem;
            }

            .number-display {
                font-size: 3rem;
            }

            .game-info {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <h1 class="game-title">üîÑ Backward Digit Span Test</h1>

        <div class="start-screen" id="startScreen">
            <h2>Get Ready!</h2>
            <div class="game-rules">
                <h3>Test Rules:</h3>
                <ul>
                    <li>12 levels total, each level shows numbers automatically</li>
                    <li>Numbers appear for 1 second each</li>
                    <li>Memorize the entire sequence</li>
                    <li><strong>Enter numbers in REVERSE order!</strong></li>
                    <li>Level 1: 2 digits, Level 2: 3 digits... up to 12 digits</li>
                    <li>Scoring: Level 1 = 5 points, Level 2 = 10 points... Level 12 = 60 points</li>
                    <li>Total: 510 points maximum</li>
                </ul>
            </div>
            <button class="start-btn" onclick="game.startGame()">Start Test</button>
        </div>

        <div class="game-screen" id="gameScreen" style="display: none;">
            <div class="progress-bar">
                <div class="progress-grid" id="progressGrid"></div>
            </div>

            <div class="game-info">
                <div class="level-indicator" id="levelIndicator">Level 1</div>
                <div class="score-indicator" id="scoreIndicator">
                    Score: <span id="currentScore">0</span> / 510
                </div>
            </div>

            <div class="timer-bar">
                <div class="timer-fill" id="timerFill"></div>
            </div>

            <div class="number-display" id="numberDisplay"></div>

            <div class="input-area" id="inputArea" style="display: none;">
                <input type="text" class="answer-input" id="answerInput" placeholder="Enter numbers in reverse" maxlength="12" inputmode="numeric" autocomplete="off">
                <button class="submit-btn" id="submitBtn" onclick="game.submitAnswer()">Submit</button>
                <div class="feedback instruction" id="feedback">Enter the digits you saw in reverse order</div>
            </div>
        </div>

        <div class="result-screen" id="resultScreen" style="display: none;">
            <h2>Test Complete!</h2>
            <div class="score-display" id="scoreDisplay">0 points</div>
            <div class="performance" id="performance">Performance</div>
            <div class="action-buttons" style="display: flex; gap: 15px; justify-content: center; margin-top: 20px; flex-wrap: wrap;">
                <button class="restart-btn" onclick="game.restartGame()">Try Again</button>
                <button class="share-btn" id="shareButton" onclick="game.showShareOptions()" style="padding: 15px 40px; font-size: 1.2rem; font-weight: 600; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; border-radius: 12px; cursor: pointer; transition: transform 0.2s;">üìä Share My Score</button>
            </div>
            <div class="navigation-links" style="margin-top: 30px; text-align: center;">
                <a href="index.html" style="margin: 0 15px; color: #667eea; text-decoration: none; font-weight: 500;">üè† Home</a>
                <a href="working-memory.html" style="margin: 0 15px; color: #667eea; text-decoration: none; font-weight: 500;">üß† Learn About Working Memory</a>
                <a href="memory-training.html" style="margin: 0 15px; color: #667eea; text-decoration: none; font-weight: 500;">üí™ Training Methods</a>
            </div>
        </div>
    </div>

    <script>
        'use strict';

        class BackwardDigitSpanGame {
            constructor() {
                this.currentLevel = 0;
                this.totalScore = 0;
                this.currentNumber = '';
                this.gameActive = false;
                this.levelResults = [];
                this.sequence = [];
                this.maxLevel = 12;

                // Share functionality
                this.shareManager = null;
                this.shareData = null;

                this.dom = {
                    startScreen: document.getElementById('startScreen'),
                    gameScreen: document.getElementById('gameScreen'),
                    resultScreen: document.getElementById('resultScreen'),
                    levelIndicator: document.getElementById('levelIndicator'),
                    currentScore: document.getElementById('currentScore'),
                    numberDisplay: document.getElementById('numberDisplay'),
                    inputArea: document.getElementById('inputArea'),
                    answerInput: document.getElementById('answerInput'),
                    submitBtn: document.getElementById('submitBtn'),
                    feedback: document.getElementById('feedback'),
                    progressGrid: document.getElementById('progressGrid'),
                    scoreDisplay: document.getElementById('scoreDisplay'),
                    performance: document.getElementById('performance')
                };

                this.init();
            }

            init() {
                this.initProgressGrid();
                this.initShareManager();
                this.answerInput?.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.submitAnswer();
                    }
                });
            }

            /**
             * Initialize share manager
             */
            initShareManager() {
                if (window.ShareCardGenerator && window.ShareManager) {
                    const generator = new window.ShareCardGenerator();
                    this.shareManager = new window.ShareManager();
                    this.shareManager.init(generator);
                } else {
                    console.warn('Share modules not loaded');
                }
            }

            /**
             * Prepare data for sharing
             */
            prepareShareData(scoreLevel, correctCount) {
                if (!this.shareManager) return;

                const totalLevels = this.levelResults.length;
                const errorRate = totalLevels > 0
                    ? Math.round(((totalLevels - correctCount) / totalLevels) * 100)
                    : 0;

                const percentile = Math.min(95, Math.floor((this.totalScore / 510) * 100));

                this.shareData = {
                    score: this.totalScore,
                    scoreLevel: scoreLevel,
                    percentile: percentile,
                    errorRate: errorRate,
                    completionTime: '4:20',
                    suggestions: [
                        'Continue training to improve memory capacity',
                        'Try longer digit sequences for better results',
                        'Practice regularly to maintain progress'
                    ],
                    chartData: {
                        memoryScore: Math.min(100, Math.floor(this.totalScore / 5)),
                        attentionScore: Math.min(100, Math.floor(this.totalScore / 6)),
                        speedScore: Math.min(100, Math.floor(this.totalScore / 4))
                    }
                };
            }

            /**
             * Show share options
             */
            showShareOptions() {
                if (!this.shareManager) {
                    alert('Share feature is not available');
                    return;
                }

                if (!this.shareData) {
                    alert('No data to share');
                    return;
                }

                this.shareManager.showShareOverlay(this.shareData);
            }

            initProgressGrid() {
                this.dom.progressGrid.innerHTML = '';
                for (let i = 0; i < this.maxLevel; i++) {
                    const cell = document.createElement('div');
                    cell.className = 'progress-cell';
                    this.dom.progressGrid.appendChild(cell);
                }
            }

            updateProgressGrid() {
                const cells = this.dom.progressGrid.children;
                for (let i = 0; i < cells.length; i++) {
                    cells[i].className = 'progress-cell';
                    if (i < this.currentLevel) {
                        cells[i].classList.add('completed');
                    } else if (i === this.currentLevel) {
                        cells[i].classList.add('active');
                    }
                }
            }

            startGame() {
                this.currentLevel = 0;
                this.totalScore = 0;
                this.levelResults = [];
                this.gameActive = true;

                this.dom.startScreen.style.display = 'none';
                this.dom.resultScreen.style.display = 'none';
                this.dom.gameScreen.style.display = 'block';

                this.nextLevel();
            }

            nextLevel() {
                this.currentLevel++;

                if (this.currentLevel > this.maxLevel) {
                    this.endGame();
                    return;
                }

                this.dom.levelIndicator.textContent = `Level ${this.currentLevel}`;
                this.dom.currentScore.textContent = this.totalScore;

                this.updateProgressGrid();

                this.sequence = this.generateSequence(this.currentLevel + 1);
                this.displaySequence();
            }

            generateSequence(length) {
                const seq = [];
                for (let i = 0; i < length; i++) {
                    seq.push(Math.floor(Math.random() * 10));
                }
                return seq;
            }

            displaySequence() {
                this.dom.inputArea.style.display = 'none';
                this.dom.numberDisplay.style.display = 'flex';

                let index = 0;
                const displayInterval = setInterval(() => {
                    if (index < this.sequence.length) {
                        this.dom.numberDisplay.textContent = this.sequence[index];
                        this.dom.numberDisplay.classList.add('fade');
                        setTimeout(() => this.dom.numberDisplay.classList.remove('fade'), 500);
                        index++;
                    } else {
                        clearInterval(displayInterval);
                        this.showInput();
                    }
                }, 1000);
            }

            showInput() {
                this.dom.numberDisplay.style.display = 'none';
                this.dom.inputArea.style.display = 'block';
                this.dom.answerInput.value = '';
                this.dom.answerInput.focus();
                this.dom.feedback.textContent = 'Enter the digits in REVERSE order';
                this.dom.feedback.className = 'feedback instruction';
            }

            submitAnswer() {
                const userInput = this.dom.answerInput.value.trim();

                if (!userInput) {
                    this.showError('Please enter numbers');
                    return;
                }

                if (!/^\d+$/.test(userInput)) {
                    this.showError('Only numbers allowed');
                    this.dom.answerInput.classList.add('error');
                    setTimeout(() => this.dom.answerInput.classList.remove('error'), 500);
                    return;
                }

                const userDigits = userInput.split('').map(Number);
                const reversedSequence = [...this.sequence].reverse();

                const isCorrect = JSON.stringify(userDigits) === JSON.stringify(reversedSequence);

                if (isCorrect) {
                    this.handleCorrectAnswer();
                } else {
                    this.handleIncorrectAnswer();
                }
            }

            handleCorrectAnswer() {
                const points = this.currentLevel * 5;
                this.totalScore += points;
                this.levelResults.push(true);

                this.dom.feedback.textContent = `Correct! +${points} points`;
                this.dom.feedback.className = 'feedback correct';

                setTimeout(() => this.nextLevel(), 1500);
            }

            handleIncorrectAnswer() {
                this.levelResults.push(false);

                const reversedSequence = [...this.sequence].reverse().join('');
                this.dom.feedback.innerHTML = `Incorrect. The correct answer was: <strong>${reversedSequence}</strong>`;
                this.dom.feedback.className = 'feedback incorrect';

                setTimeout(() => this.endGame(), 2500);
            }

            showError(message) {
                this.dom.feedback.textContent = message;
                this.dom.feedback.className = 'feedback incorrect';
            }

            endGame() {
                this.gameActive = false;
                this.dom.gameScreen.style.display = 'none';
                this.dom.resultScreen.style.display = 'block';

                const correctAnswers = this.levelResults.filter(r => r).length;
                const completedLevels = this.levelResults.length;

                // Determine score level
                let scoreLevel;
                if (this.totalScore >= 400) {
                    scoreLevel = 'Master';
                } else if (this.totalScore >= 250) {
                    scoreLevel = 'Excellent';
                } else if (this.totalScore >= 150) {
                    scoreLevel = 'Good';
                } else {
                    scoreLevel = 'Beginner';
                }

                this.dom.scoreDisplay.textContent = `${this.totalScore} points`;
                this.dom.performance.textContent = `${correctAnswers}/${completedLevels} levels completed`;

                // Prepare share data
                this.prepareShareData(scoreLevel, correctAnswers);
            }

            restartGame() {
                this.startGame();
            }
        }

        const game = new BackwardDigitSpanGame();
    </script>

    <!-- Share Card Dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js" integrity="sha256-cxwXoEiC8wYPU1Q6h8BsU8U9DqS7EJVZ7Y6J+g7xPjM=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js" integrity="sha256-80qMsZxX6SwXDNEZ+7KzT8m1F4B1hZsT7W5bA3Q3T8w=" crossorigin="anonymous"></script>

    <!-- Share Card Generator -->
    <script src="js/share-card-generator.js"></script>

    <!-- Footer -->
    <footer style="background: var(--text-primary); color: white; padding: 3rem 0; margin-top: 4rem;">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <div class="logo" style="background: var(--gradient-accent); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 1rem;">üß† DigitSpanTest.online</div>
                    <p style="color: var(--text-light); margin-bottom: 1rem;">Free online memory training and cognitive assessment tools</p>
                </div>
                <div class="footer-section">
                    <h3 style="color: white; font-size: 1.1rem; margin-bottom: 1rem;">Quick Links</h3>
                    <ul style="list-style: none; padding: 0;">
                        <li style="margin-bottom: 0.5rem;"><a href="https://digitspantest.online/" style="color: var(--accent-color);">Home</a></li>
                        <li style="margin-bottom: 0.5rem;"><a href="https://digitspantest.online/game.html" style="color: var(--accent-color);">Standard Test</a></li>
                        <li style="margin-bottom: 0.5rem;"><a href="https://digitspantest.online/backward-digit-span.html" style="color: var(--accent-color);">Backward Test</a></li>
                        <li style="margin-bottom: 0.5rem;"><a href="https://digitspantest.online/memory-techniques.html" style="color: var(--accent-color);">Memory Techniques</a></li>
                        <li style="margin-bottom: 0.5rem;"><a href="https://digitspantest.online/working-memory.html" style="color: var(--accent-color);">Working Memory</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h3 style="color: white; font-size: 1.1rem; margin-bottom: 1rem;">Legal</h3>
                    <ul style="list-style: none; padding: 0;">
                        <li style="margin-bottom: 0.5rem;"><a href="privacy-policy.html" style="color: var(--accent-color);">Privacy Policy</a></li>
                        <li style="margin-bottom: 0.5rem;"><a href="terms-of-service.html" style="color: var(--accent-color);">Terms</a></li>
                        <li style="margin-bottom: 0.5rem;"><a href="contact.html" style="color: var(--accent-color);">Contact Us</a></li>
                    </ul>
                </div>
            </div>
            <div style="text-align: center; margin-top: 2rem; padding-top: 2rem; border-top: 1px solid #333;">
                <p style="color: var(--text-light); font-size: 0.9rem;">&copy; 2025 DigitSpanTest.online. All rights reserved.</p>
            </div>
        </div>
    </footer>
</body>
</html>
